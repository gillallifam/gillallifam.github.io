<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BKP Server</title>
    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
    <script src="../js/lz-string.min.js"></script>
    <script src="../js/localforage.min.js"></script>
    <script src="../js/cli-commom.js"></script>
</head>

<body>
    <h2>Clients</h2>
    <p id="cliNames">No clients</p>
    <script>
        /* let headers = new Headers()
        let username = "admin"
        let password = 123456
        headers.set('Authorization', 'Basic ' + btoa(username + ":" + password));
        headers.set('Access-Control-Allow-Origin', '*');
        fetch('http://192.168.0.3:9099/pass', {
            method:'GET',
            mode: 'cors',
            headers: headers,
        }).then(async function (res) {
            console.log(res);
        }) */
        /* let pass = localStorage.getItem("userPass")
        if (!pass) alert("password") */
        window.addEventListener("beforeunload", function (e) {
            // Do something
            e.preventDefault()
        }, false);
        var mapClients = new Map()
        var bkpStore = localforage.createInstance({
            name: "bkpStore",
            storeName: 'clients',
        });
        let cliNames = document.getElementById("cliNames")
        var serverId = "BKPServer1"
        let p0

        async function init() {
            p0 = await socketConn(serverId)
            //console.log(p0);
            p0.on("disconnected", () => {
                let rcnt = setInterval(() => {
                    console.log("Connecting to Peer.");
                    try {
                        p0.reconnect()
                        if (!p0.disconnected) {
                            console.log("Reconnected to server.");

                            clearInterval(rcnt)
                        }
                    } catch (error) {
                        console.log("Checking server.");
                    }

                }, 5000);
            })
            p0.on('connection', function (conn) {
                mapClients.set(conn.peer, { conn, lastSeen: Date.now() })
                let cliName = conn.peer
                cliNames.innerHTML = Array.from(mapClients.keys()).join(",")
                conn.on('data', async function (data) {
                    //console.log(data);
                    switch (data.msg) {
                        case "alive":
                            conn.send({ msg: "y" })
                            break;
                        case "ping":
                            console.log("Ping from " + conn.peer);
                            conn.send({ msg: "ping", time: Date.now() })
                            break;
                        case "bkpData":
                            console.log("Received " + data.payLoad.length + " bytes " + conn.peer);
                            bkpStore.setItem(data.cliId, data.payLoad)
                            conn.send({ msg: data.msg, status: "success" })
                            break;
                        case "getData":
                            console.log("Send data to:", conn.peer);
                            let result = await bkpStore.getItem(data.cliId)
                            conn.send({ msg: data.msg, status: "success", payLoad: result })
                            break;
                        default:
                            break;
                    }
                });
                conn.on('close', async function () {
                    console.log("closed", cliName);
                    mapClients.delete(cliName)
                })
            });
            p0.on('close', function () { console.log("Peer closed"); });
            console.log("Aguardando clientes.");

        }
        init()

        function broadCast() {
            for (const item of mapClients) {
                let { lastSeen, conn } = item[1]
                if (lastSeen > Date.now() - 3600000) {
                    console.log(conn);
                    conn.send({ msg: "ping", time: Date.now(), sender: "broadcast" })
                }
            }
        }


        async function socketConn(cnnName) {
            return new Promise((res, rej) => {
                const peer = new Peer(cnnName, {
                    host: '192.168.0.3',
                    port: 9099,
                    path: '/service/socket'
                });
                if (peer) res(peer)
                rej(null)
            })
        }
    </script>

</body>

</html>