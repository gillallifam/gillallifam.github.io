<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BKP Server</title>
    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
    <script src="../js/lz-string.min.js"></script>
    <script src="../js/localforage.min.js"></script>
    <script src="../js/cli-commom.js"></script>
</head>

<body>
    <h2>Clients</h2>
    <p id="cliNames">No clients</p>
    <script>
        var bkpStore = localforage.createInstance({
            name: "bkpStore",
            storeName: 'client',
        });
        let cliNames = document.getElementById("cliNames")
        let storeCliNames = new Set()
        var clients = new Map()
        const peer = new Peer("BKPServer1", {
            host: '172.100.11.87',
            port: 9099,
            path: '/service/socket'
        });

        console.log(peer);
        peer.on('connection', function (conn) {
            
            storeCliNames.add(conn.peer)
            cliNames.innerHTML = Array.from(storeCliNames).join(", ")
            clients.set(conn.peer, conn)
            conn.on('data', async function (data) {
                switch (data.msg) {
                    case "ping":
                        conn.send({ msg: "ping" })
                        break;
                    case "bkpData":
                        bkpStore.setItem(data.cliId, data.payLoad)
                        conn.send({ msg: data.msg, status: "success" })
                        break;
                    case "getData":
                        let result = await bkpStore.getItem(data.cliId)
                        conn.send({ msg: data.msg, status: "success", payLoad: result })
                        break;
                    default:
                        break;
                }
            });
        });
        peer.on('close', function () { console.log("Peer closed"); });
        console.log("Aguardando clientes.");
    </script>

</body>

</html>