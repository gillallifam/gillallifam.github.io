<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTC1</title>
</head>

<body>
    <button id="copy" disabled>Copy Offer/Candidates to Clipboard</button><br>
    <input id="paste" placeholder="Paste Answer/Candidates here" disabled>
    <table>
        <tr>
            <td>local</td>
            <td>remote</td>
        </tr>
        <tr>
            <td><video id="local" autoplay></video></td>
            <td><video id="remote" autoplay></video></td>
        </tr>
    </table>

    <script>
        // Use an offscreen canvas as the video source.
        /* const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        let color = 0;
        const draw = () => {
            color = (color + 2) % 255;
            context.fillStyle = `rgb(${color}, 0, 0)`;
            context.fillRect(0, 0, 300, 150);
            requestAnimationFrame(draw);
        }
        draw(); */

        /* const localVideo = document.getElementById('local');
        const stream = canvas.captureStream();
        localVideo.srcObject = stream; */

        const peerConnection = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
        //console.log(peerConnection);
        dataChannel = peerConnection.createDataChannel("label", {});
        dataChannel.onopen = onDataChannelStateChange;
        dataChannel.onclose = onDataChannelStateChange;
        //console.log(dataChannel);


        function onDataChannelStateChange() {
            var readyState = dataChannel.readyState;
            if (readyState === 'open') {
                console.log('dataChannel open');
                let cnt = 0
                setInterval(() => {
                    cnt++
                    dataChannel.send("ola " + cnt)
                }, 1000);
            } else {
                console.log(readyState);
            }
        }

        //stream.getTracks().forEach(t => peerConnection.addTrack(t, stream));

        // Save a list of ice candidates to send to the peer
        const iceCandidates = [];
        peerConnection.onicecandidate = e => {
            if (e.candidate) {
                iceCandidates.push(e.candidate);
            }
        };
   

        (async () => {
            const copyButton = document.getElementById('copy');

            peerConnection.onicegatheringstatechange = () => {
                if (peerConnection.iceGatheringState === 'complete') {
                    copyButton.disabled = false;
                    console.log('Offer ready, click copy button.');
                }
            };

            //{"offer":{"type":"offer","sdp":"v=0\r\no=- 4170734330346317633 2 IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\na=group:BUNDLE 0\r\na=msid-semantic: WMS\r\nm=application 9 UDP/DTLS/SCTP webrtc-datachannel\r\nc=IN IP4 0.0.0.0\r\na=ice-ufrag:eXa8\r\na=ice-pwd:YONVTm8aNdxfftZ9kHNXCpA9\r\na=ice-options:trickle\r\na=fingerprint:sha-256 52:52:50:65:E3:42:C5:75:07:21:FC:4B:D3:74:78:EE:A2:B2:34:30:FC:E3:82:98:87:B5:18:F2:19:F6:AB:9C\r\na=setup:actpass\r\na=mid:0\r\na=sctp-port:5000\r\na=max-message-size:262144\r\n"},"iceCandidates":[{"candidate":"candidate:1511920713 1 udp 2113937151 4fe23000-a2be-4f1a-ac7a-f92333a8ecf8.local 39353 typ host generation 0 ufrag eXa8 network-cost 999","sdpMid":"0","sdpMLineIndex":0},{"candidate":"candidate:2268068307 1 udp 2113939711 e80f887f-b5fc-4c29-b468-9553f5c77400.local 44018 typ host generation 0 ufrag eXa8 network-cost 999","sdpMid":"0","sdpMLineIndex":0},{"candidate":"candidate:842163049 1 udp 1677729535 143.137.95.17 39353 typ srflx raddr 0.0.0.0 rport 0 generation 0 ufrag eXa8 network-cost 999","sdpMid":"0","sdpMLineIndex":0}]}

            const offer = await peerConnection.createOffer();
            let userid = "User1"
            //offer.userid = "User1"
            //console.log(offer);
            //console.log(JSON.stringify(offer));
            //console.log(makeHash(JSON.stringify(offer)));
            await peerConnection.setLocalDescription(offer);

            const pasteInput = document.getElementById('paste');

            copyButton.onclick = () => {
                console.log(offer);
                //console.log(JSON.stringify({ userid, offer, iceCandidates }));
                navigator.clipboard.writeText(JSON.stringify({ userid, offer, iceCandidates }));
                console.log('Offer copied/candidates. Paste in Answerer example.');

                pasteInput.disabled = false;
            };

            pasteInput.onpaste = async (e) => {
                const { userid: from, answer, iceCandidates } = JSON.parse(e.clipboardData.getData('text/plain'));
                console.log("Response from " + from);
                //console.log(answer, iceCandidates);
                await peerConnection.setRemoteDescription(answer);
                iceCandidates.forEach(c => peerConnection.addIceCandidate(c));
                //dataChannel.send("ddadadsadsadsa")
                console.log(peerConnection);
            };
        })();

        function makeHash(str) {
            var hash = 0, i, chr;
            if (str.length === 0) return hash;
            for (i = 0; i < str.length; i++) {
                chr = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + chr;
                hash |= 0; // Convert to 32bit integer
            }
            return hash;
        };
    </script>

    <style>
        video {
            width: 150px;
            height: 100px;
        }

        input {
            width: 250px;
        }
    </style>


</body>

</html>