<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
    <script src="../js/lz-string.min.js"></script>
    <script src="../js/cli-commom.js"></script>
</head>

<body>

    <button id="pingServer">Ping</button>
    <button id="productList">Products</button>
    <button id="delivery">Delivery</button>
    <input id="inpName" type="text" placeholder="name" />
    <button id="setName">set</button>
    <input id="inpTarget" type="text" placeholder="target" />
    <button id="setTarget">set</button>
    <br>
    <input id="inpMsg" type="text" placeholder="msg" />
    <button id="sendMsg">send</button>

    <script>

        const setName = document.getElementById("setName")
        const inpName = document.getElementById("inpName")
        const setTarget = document.getElementById("setTarget")
        const inpTarget = document.getElementById("inpTarget")
        const pingServer = document.getElementById("pingServer")
        const productList = document.getElementById("productList")
        const delivery = document.getElementById("delivery")
        const sendMsg = document.getElementById("sendMsg")
        const inpMsg = document.getElementById("inpMsg")


        var cliId = localStorage.getItem("userid") || makeid(6)
        let pTask, pP, connP, canTalk = true
        inpName.value = cliId
        document.title = cliId
        var target = localStorage.getItem("target")
        if (location.search) {
            //console.log(location.search);//todo multi params
            target = location.search.substr(1).split("=")[1];
            localStorage.setItem("target", target)
            taskSend({ cliId, action: "productList", time: Date.now() })
        }
        inpTarget.value = target
        var totalItems = 1000


        async function taskSend(data) {
            if (!target || !canTalk) { console.log("Please wait!"); return }
            canTalk = false
            pTask = pTask || await socketConn(cliId + "-t")
            //console.log(pTask);
            let tout = setTimeout(() => {
                //connP.close();
                //connP = null
                console.error("Task failed: Timeout.")
                canTalk = true
            }, 3000);
            if (connP && connP.open) {
                //console.log(`Sending to ${connP.peer}`);
                clearTimeout(tout)
                connP.send(data);
            } else {
                connP = await connConfig(pTask)
                connP.on('open', function () {
                    //console.log(`Connected to ${connP.peer}`);
                    clearTimeout(tout)
                    connP.send(data);
                })
            }
        }

        function setClicks() {
            setName.onclick = async () => {
                if (inpName.value !== "") {
                    localStorage.setItem("userid", inpName.value)
                    cliId = inpName.value
                    location.reload()
                }
            }

            setTarget.onclick = async () => {
                if (inpTarget.value !== "") {
                    target = inpTarget.value
                    localStorage.setItem("target", target)
                }
            }

            pingServer.onclick = async () => {
                console.log(Date.now());
                taskSend({ cliId, action: "ping" })
            }

            productList.onclick = async () => {
                taskSend({ cliId, action: "productList", name: "", category: "" })
            }

            delivery.onclick = async () => {
                //taskSend({ cliId, action: "delivery", body: "Um x-bacon.", time: Date.now() })
                taskSend({ cliId, action: "promotions", time: Date.now() })
            }

            sendMsg.onclick = async () => {
                if (inpMsg.value) taskSend({ cliId, action: "msg", text: inpMsg.value, time: Date.now() })
            }
        }

        setClicks()

        async function dataHandler(data) {
            switch (data.action) {
                case "ping":
                    console.log(data);
                    break;
                case "productList":
                    console.log(data.payLoad);
                    break;
                case "promotions":
                    console.log(data.payLoad);
                    break;
                case "msg":
                    console.log(data);
                    break;
                case "delivery":
                    console.log(data);
                    break
                default:
                    break;
            }
        }

        async function socketConn(peerName) {
            return new Promise((res, rej) => {
                const peer = new Peer(peerName, {
                    host: '192.168.0.2',
                    port: 9099,
                    path: '/service/socket'
                });
                peer.on('close', function () { pTask == null });
                if (peer) res(peer)
                rej(null)
            })
        }

        async function connConfig(peer) {
            let c = peer.connect(target + "-p")
            c.on('data', function (res) {
                dataHandler(res)
                setTimeout(() => {
                    //connP.close();
                    canTalk = true
                }, 5000);
            })
            c.on('close', async () => {
                console.log(`Connection ${target} closed.`);
            })
            return c
        }
    </script>

</body>

</html>