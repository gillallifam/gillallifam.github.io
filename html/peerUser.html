<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
    <script src="../js/lz-string.min.js"></script>
    <script src="../js/cli-commom.js"></script>
</head>

<body>
    
    <button id="pingServer">Ping</button>
    <button id="productList">Products</button>
    <input id="inpName" type="text" placeholder="name" />
    <button id="setName">set</button>
    <script>


        const setName = document.getElementById("setName")
        const inpName = document.getElementById("inpName")
        const pingServer = document.getElementById("pingServer")
        const productList = document.getElementById("productList")
        let bkpServer = "gill1-p"
        var cliId = localStorage.getItem("userid") || makeid(6)
        inpName.value = cliId
        document.title = cliId
        var totalItems = 1000
        let pP, connP, svLive

        async function init() {
            pP = await socketConn(cliId + "-p")

            pP.on("disconnected", () => {
                let rcnt1 = setInterval(async () => {
                    console.log("Connecting to Peer.");
                    try {
                        pP.reconnect()
                        if (!pP.disconnected) {
                            clearInterval(rcnt1)
                            //connP = await connConfig(pP)
                            console.log("Reconnected to peer.");
                        }
                    } catch (error) {
                        console.error("Peer error.");
                    }
                }, 5000);
            })
            connP = await connConfig(pP)

            setInterval(() => {
                taskSend({ cliId, msg: "alive" })
            }, 60000);
        }

        init()


        async function taskSend(data) {
            if (!bkpServer) { console.log("No bkp server."); return; }
            let pTask = pP || await socketConn(cliId + "-t")
            let tout = setTimeout(() => {
                connP.close();
                console.error("Task failed: Timeout.")
            }, 2000);
            if (connP && connP.open) {
                connP.send(data); clearTimeout(tout);
            } else {
                console.log("Connecting to bkp server.");
                connP = await connConfig(pTask)
                connP.on('open', function () {
                    console.log("open");
                    clearTimeout(tout)
                    connP.send(data);
                })
            }
        }

        const bkpData = []
        function setClicks() {
            setName.onclick = async () => {
                if (inpName.value !== "") {
                    localStorage.setItem("userid", inpName.value)
                    cliId = inpName.value
                    location.reload()
                }
            }

            pingServer.onclick = async () => {
                console.log(Date.now());
                taskSend({ cliId, msg: "ping" })
            }
            productList.onclick = async () => {
                taskSend({ cliId, msg: "productList" })
            }
        }

        setClicks()
        async function dataHandler(data) {
            switch (data.msg) {
                case "alive":
                    svLive = Date.now()
                    break;
                case "ping":
                    console.log(data);
                    break;
                case "bkpData":
                    console.log(data);
                    break;
                case "productList":
                    console.log(data.payLoad);
                    break;    
                case "getData":
                    if (data.payLoad) console.log(JSON.parse(LZString.decompressFromUTF16(data.payLoad)));
                    else console.log("No data.");
                    break;
                case "alertMsg":
                    console.log(data);
                    break
                default:
                    break;
            }
        }

        async function socketConn(cnnName) {
            return new Promise((res, rej) => {
                const peer = new Peer(cnnName, {
                    host: '192.168.0.3',
                    port: 9099,
                    path: '/service/socket'
                });
                if (peer) res(peer)
                rej(null)
            })
        }

        async function connConfig(peer) {
            let c = peer.connect(bkpServer)
            c.on('data', function (res) {
                dataHandler(res)
                if (!pP) { connP.close(); connP = null; }
            })
            c.on('close', async () => {
                console.log("Conn closed", bkpServer);
            })
            return c
        }
    </script>

</body>

</html>