<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SPServe1</title>
  <script src="./js/simplepeer.min.js"></script>
</head>

<body>
  <style>
    #outgoing {
      width: 600px;
      word-wrap: break-word;
      white-space: normal;
    }
  </style>
  <pre id="outgoing"></pre>
  <script>
    const userid = 'Server1'
    const users = {
      User1: "8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92",
      User2: "481f6cc0511143ccdd7e2d1b1b94faf0a700a8b49cd13922a70b5ae28acaa8c5",
      User3: "481f6cc0511143ccdd7e2d1b1b94faf0a700a8b49cd13922a70b5ae28acaa8c5",
      Server1: "8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92"
    }

    const connecteds = {}

    let webSocket = new WebSocket(`ws://localhost:3456/?userid=${userid}&passhash=8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92`)
    webSocket.onopen = function (event) {
      console.log("Connected to signaller.");
      //webSocket.send(JSON.stringify({ action: "activate", userid: "Server1", passhash: "8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92" }))
    };

    webSocket.onmessage = function (msg) {
      let data = JSON.parse(msg.data)

      switch (data.action) {
        case "autorization":
          //console.log(data);
          if (users[data.userid] && users[data.userid] === data.passhash) {
            console.log("User allowed.", data.userid);
            data.status = true
            //console.log("Sendind ws");
            //console.log(data);
            webSocket.send(JSON.stringify(data))
            //console.log(users);
          }
          break
        case "offer":
          //console.log('offer');
          let offer = data.offer
          if (users[offer.userid] && users[offer.userid] === offer.passhash) {
            //console.log("Access ok.", offer.userid);
            createPeer(offer)
          } else {
            console.error(offer.userid, "Access denied.");
          }
          break;

        default:
          break;
      }
    };

    const peers = {}

    function createPeer(offer) {
      //console.log(offer);
      let p = new SimplePeer({
        initiator: false,
        trickle: false
      })

      p.on('connect', () => {
        //console.log(p);
        connecteds[offer.userid] = p
        console.log('Connected to ' + offer.userid)
        console.log(connecteds);
      })

      p.on('data', msg => {
        let data = JSON.parse(msg)
        console.log(data);
        switch (data.action) {
          case "msg":
            //console.log(data.text);
            p.send(JSON.stringify({ action: "confirm", id: data.id }))
            break;
          default:
            console.error("Unknow action");
            break;
        }
      })
      p.on('error', err => console.log('error', err))

      p.on('signal', data => {
        //console.log(data);
        data.target = offer.userid
        data.userid = userid
        webSocket.send(JSON.stringify({ action: "answer", answer: data }))
        document.querySelector('#outgoing').textContent = JSON.stringify(data)
      })
      peers[offer.userid] = p
      p.signal(offer)
    }

    /* async function sha256(message) {
      // encode as UTF-8
      const msgBuffer = new TextEncoder().encode(message);

      // hash the message
      const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);

      // convert ArrayBuffer to Array
      const hashArray = Array.from(new Uint8Array(hashBuffer));

      // convert bytes to hex string
      const hashHex = hashArray.map(b => ('00' + b.toString(16)).slice(-2)).join('');
      console.log(hashHex);
      return hashHex;
    }

    sha256("654321") */
  </script>
</body>

</html>